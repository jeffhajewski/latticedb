name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version (without v prefix)'
        required: true
        type: string
      publish_pypi:
        description: 'Publish to PyPI'
        type: boolean
        default: false
      publish_npm:
        description: 'Publish to npm'
        type: boolean
        default: false

env:
  ZIG_VERSION: "0.15.2"

jobs:
  # ============================================
  # Build native binaries for all platforms
  # Using Zig cross-compilation from single runner
  # ============================================
  build-native:
    name: Build Native Libraries
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        target:
          - x86_64-linux-gnu
          - aarch64-linux-gnu
          - x86_64-macos
          - aarch64-macos
          # TODO: Add x86_64-windows-gnu once vfs.zig/database.zig are ported from POSIX APIs

    steps:
      - uses: actions/checkout@v4

      - name: Install Zig
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: ${{ env.ZIG_VERSION }}

      - name: Build shared library
        run: |
          mkdir -p dist/build/${{ matrix.target }}/{bin,lib,include}

          zig build shared \
            -Dtarget=${{ matrix.target }} \
            -Doptimize=ReleaseFast

          # Copy to target directory
          cp zig-out/lib/liblattice.* dist/build/${{ matrix.target }}/lib/ || true
          cp zig-out/lib/lattice.* dist/build/${{ matrix.target }}/lib/ || true

      - name: Build CLI
        run: |
          zig build cli \
            -Dtarget=${{ matrix.target }} \
            -Doptimize=ReleaseFast

          # Copy to target directory
          cp zig-out/bin/lattice* dist/build/${{ matrix.target }}/bin/ || true

      - name: Copy header
        run: cp include/lattice.h dist/build/${{ matrix.target }}/include/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: native-${{ matrix.target }}
          path: dist/build/${{ matrix.target }}

  # ============================================
  # Create GitHub Release with tarballs
  # ============================================
  release-github:
    name: GitHub Release
    needs: build-native
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          fi

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: native-*
          path: dist/build

      - name: Reorganize artifacts
        run: |
          mkdir -p dist/build-final
          for dir in dist/build/native-*; do
            target=$(basename "$dir" | sed 's/native-//')
            mv "$dir" "dist/build-final/$target"
          done
          rm -rf dist/build
          mv dist/build-final dist/build

      - name: Create release packages
        run: |
          VERSION=${{ steps.version.outputs.version }}
          mkdir -p dist/release

          for target_dir in dist/build/*; do
            target=$(basename "$target_dir")
            archive="latticedb-${VERSION}-${target}.tar.gz"

            echo "Creating $archive..."
            tar -czf "dist/release/$archive" \
              -C "$target_dir" \
              --transform "s,^,latticedb-${VERSION}/," \
              .
          done

          # Generate checksums
          cd dist/release
          shasum -a 256 *.tar.gz > SHA256SUMS
          cat SHA256SUMS

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: LatticeDB v${{ steps.version.outputs.version }}
          files: dist/release/*
          generate_release_notes: true
          draft: ${{ github.event_name == 'workflow_dispatch' }}

  # ============================================
  # Build Python wheels for each platform
  # ============================================
  build-wheels:
    name: Build Wheel (${{ matrix.os }})
    needs: build-native
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-linux-gnu
            python_platform: manylinux_2_17_x86_64
          - os: ubuntu-latest
            target: aarch64-linux-gnu
            python_platform: manylinux_2_17_aarch64
          - os: macos-13  # Intel
            target: x86_64-macos
            python_platform: macosx_10_9_x86_64
          - os: macos-14  # ARM64
            target: aarch64-macos
            python_platform: macosx_11_0_arm64
          # TODO: Add windows-latest / win_amd64 once Zig source compiles for Windows

    steps:
      - uses: actions/checkout@v4

      - name: Download native library
        uses: actions/download-artifact@v4
        with:
          name: native-${{ matrix.target }}
          path: native-lib

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install build tools
        run: pip install build wheel

      - name: Copy native library to package
        run: |
          mkdir -p bindings/python/src/latticedb/lib
          cp native-lib/lib/* bindings/python/src/latticedb/lib/
          ls -la bindings/python/src/latticedb/lib/

      - name: Build wheel
        run: |
          cd bindings/python
          python -m build --wheel

      - name: Upload wheel
        uses: actions/upload-artifact@v4
        with:
          name: wheel-${{ matrix.target }}
          path: bindings/python/dist/*.whl

  # ============================================
  # Smoke test wheels
  # ============================================
  smoke-test-wheels:
    name: Smoke Test (${{ matrix.os }})
    needs: build-wheels
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-linux-gnu
          - os: macos-14
            target: aarch64-macos

    steps:
      - name: Download wheel
        uses: actions/download-artifact@v4
        with:
          name: wheel-${{ matrix.target }}
          path: dist

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install and test
        run: |
          python -m venv test-env
          source test-env/bin/activate
          pip install dist/*.whl
          python -c "from latticedb import Database; print('Smoke test passed')"

  # ============================================
  # Build source distribution
  # ============================================
  build-sdist:
    name: Build Source Distribution
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install build tools
        run: pip install build

      - name: Build sdist
        run: |
          cd bindings/python
          python -m build --sdist

      - name: Upload sdist
        uses: actions/upload-artifact@v4
        with:
          name: sdist
          path: bindings/python/dist/*.tar.gz

  # ============================================
  # Publish to PyPI
  # ============================================
  publish-pypi:
    name: Publish to PyPI
    needs: [build-wheels, build-sdist, smoke-test-wheels, release-github]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && inputs.publish_pypi)

    environment:
      name: pypi
      url: https://pypi.org/p/latticedb

    permissions:
      id-token: write  # Required for trusted publishing

    steps:
      - name: Download all wheels
        uses: actions/download-artifact@v4
        with:
          pattern: wheel-*
          path: dist
          merge-multiple: true

      - name: Download sdist
        uses: actions/download-artifact@v4
        with:
          name: sdist
          path: dist

      - name: List distributions
        run: ls -la dist/

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist/

  # ============================================
  # Build and publish npm package
  # Downloads all platform shared libraries and
  # bundles them into a single package for koffi
  # ============================================
  build-npm:
    name: Build npm Package
    needs: build-native
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Download Linux x86_64 library
        uses: actions/download-artifact@v4
        with:
          name: native-x86_64-linux-gnu
          path: native-x86_64-linux-gnu

      - name: Download Linux aarch64 library
        uses: actions/download-artifact@v4
        with:
          name: native-aarch64-linux-gnu
          path: native-aarch64-linux-gnu

      - name: Download macOS x86_64 library
        uses: actions/download-artifact@v4
        with:
          name: native-x86_64-macos
          path: native-x86_64-macos

      - name: Download macOS aarch64 library
        uses: actions/download-artifact@v4
        with:
          name: native-aarch64-macos
          path: native-aarch64-macos

      # TODO: Download native-x86_64-windows-gnu once Windows build is supported

      - name: Copy shared libraries into package
        run: |
          PKG=bindings/typescript

          # linux-x64
          mkdir -p $PKG/lib/linux-x64
          cp native-x86_64-linux-gnu/lib/liblattice.so $PKG/lib/linux-x64/ || true

          # linux-arm64
          mkdir -p $PKG/lib/linux-arm64
          cp native-aarch64-linux-gnu/lib/liblattice.so $PKG/lib/linux-arm64/ || true

          # darwin-x64
          mkdir -p $PKG/lib/darwin-x64
          cp native-x86_64-macos/lib/liblattice.dylib $PKG/lib/darwin-x64/ || true

          # darwin-arm64
          mkdir -p $PKG/lib/darwin-arm64
          cp native-aarch64-macos/lib/liblattice.dylib $PKG/lib/darwin-arm64/ || true

          # TODO: win32-x64 once Windows build is supported

          echo "Bundled libraries:"
          find $PKG/lib -type f | sort

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        working-directory: bindings/typescript
        run: npm ci --ignore-scripts

      - name: Build TypeScript
        working-directory: bindings/typescript
        run: npm run build

      - name: Upload npm package
        uses: actions/upload-artifact@v4
        with:
          name: npm-package
          path: bindings/typescript/

  # ============================================
  # Publish to npm
  # ============================================
  publish-npm:
    name: Publish to npm
    needs: [build-npm, release-github]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && inputs.publish_npm)

    steps:
      - name: Download npm package
        uses: actions/download-artifact@v4
        with:
          name: npm-package
          path: bindings/typescript

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: List bundled libraries
        run: find bindings/typescript/lib -type f | sort || echo "No lib directory"

      - name: Publish to npm
        working-directory: bindings/typescript
        run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
